name: Rdp1

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600
    steps:
      - name: Disable NLA and Enable RDP for user
        run: |
          # Disable Network Level Authentication (NLA) for security reasons on a temporary RDP session.
          -Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\SecurityProviders\WDigest" -Name "UserAuthentication" -Value 0 -Force
          -Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "SecurityLayer" -Value 0 -Force

          # Remove any existing rule with the same name to avoid duplication
          netsh advfirewall firewall delete rule name="RDP-Tailscale"

          # Add a rule to allow RDP through the firewall for the Tailscale IP
          netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389 remoteip=any

          # Generate a random password for the user with at least one of each character type
          $rawPassword = ""
          $charSet = [char[]]([char]'!'..[char]'~') # Printable ASCII characters (33 to 126) excluding space
          $rawPassword += $charSet.Upper | Get-Random -Count 4
          $rawPassword += $charSet.Lower | Get-Random -Count 4
          $rawPassword += $charSet.Number | Get-Random -Count 4
          $rawPassword += $charSet.Special | Get-Random -Count 4
          $password = -join $rawPassword | Sort-Object | Get-Random -InputObject $rawPassword -Count 16

          # Set the password for the current user and display it securely
          $currentUser = (Get-WmiObject -Class Win32_ComputerSystem).UserName.Split('\')[-1]
          Write-Host "Setting password for user: $currentUser"
          (Get-LocalUser -Name $currentUser).SetPassword($password)
          Write-Host "Generated Password: $password"
          Write-Host "You can now connect to RDP using the password above."

          # Remove the RDP service registry settings when the runner exits
          Remove-ItemProperty -Path $installerPath -Force

      - name: Establish Tailscale Connection
        run: |
          # Bring up Tailscale with the provided auth key and set a unique hostname
          & $env:ProgramFiles\Tailscale\tailscale.exe up --authkey=$env:SECRETS.TAILSCALE_AUTH_KEY --hostname=gh-runner-$env:GITHUB_RUN_ID

          # Get the Tailscale IP and make it available as an environment variable
          $tailscaleIP = (& $env:ProgramFiles\Tailscale\tailscale.exe ip -4)
          Write-Host "TAILSCALE_IP=$tailscaleIP" >> $env:GITHUB_ENV

      - name: Verify RDP Accessibility
        run: |
          # Write-Host Tailscale IP
          Write-Host "Tailscale IP: $env:TAILSCALE_IP"

          # Test connectivity using Test-NetConnection against the Tailscale IP on port 3389
          $testResult = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389

          # Check the result and exit if TCP connection failed
          If (-not $testResult.TcpTestSucceeded) {
              Write-Host "TCP connection to RDP port 3389 failed"
              exit 1
          }

      - name: Keep Runner Active
        run: |
          # Keep runner active indefinitely (or until manually cancelled)
          Write-Host "Host: $env:HOST"
          Write-Host "Keep runner active indefinitely (or until manually cancelled)"
          Write-Host "While runner active (RDP active - Use Ctrl+C in workflow to terminate)"
          Start-Sleep -Seconds 300
          }
